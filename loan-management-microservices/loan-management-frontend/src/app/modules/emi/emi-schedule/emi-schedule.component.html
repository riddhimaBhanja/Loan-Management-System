<app-page-header
  [title]="'EMI Schedule - ' + (loan()?.applicationNumber || '')"
  subtitle="View complete EMI payment schedule"
  [showBackButton]="true"
  backRoute="/dashboard">
</app-page-header>

<div class="content-container">
  <!-- Summary Cards -->
  <div class="summary-cards" *ngIf="loan() as loanData">
    <mat-card class="summary-card">
      <mat-card-content>
        <div class="card-icon primary">
          <mat-icon>account_balance_wallet</mat-icon>
        </div>
        <div class="card-details">
          <p class="card-label">Loan Amount</p>
          <p class="card-value">{{ loanData.approvedAmount | inrCurrency }}</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card">
      <mat-card-content>
        <div class="card-icon success">
          <mat-icon>check_circle</mat-icon>
        </div>
        <div class="card-details">
          <p class="card-label">EMIs Paid</p>
          <p class="card-value">{{ getTotalPaid() }} / {{ emiSchedule().length }}</p>
          <p class="card-sublabel">{{ getTotalAmountPaid() | inrCurrency }}</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card">
      <mat-card-content>
        <div class="card-icon warning">
          <mat-icon>pending</mat-icon>
        </div>
        <div class="card-details">
          <p class="card-label">Pending EMIs</p>
          <p class="card-value">{{ getTotalPending() }}</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card" *ngIf="getTotalOverdue() > 0">
      <mat-card-content>
        <div class="card-icon danger">
          <mat-icon>error</mat-icon>
        </div>
        <div class="card-details">
          <p class="card-label">Overdue EMIs</p>
          <p class="card-value">{{ getTotalOverdue() }}</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- EMI Schedule Table -->
  <div class="table-container">
    <table mat-table [dataSource]="emiSchedule()" class="emi-table">
      <!-- EMI Number Column -->
      <ng-container matColumnDef="emiNumber">
        <th mat-header-cell *matHeaderCellDef>EMI #</th>
        <td mat-cell *matCellDef="let emi">{{ emi.installmentNumber }}</td>
      </ng-container>

      <!-- Due Date Column -->
      <ng-container matColumnDef="dueDate">
        <th mat-header-cell *matHeaderCellDef>Due Date</th>
        <td mat-cell *matCellDef="let emi">{{ emi.dueDate | date: 'dd MMM yyyy' }}</td>
      </ng-container>

      <!-- Principal Amount Column -->
      <ng-container matColumnDef="principalAmount">
        <th mat-header-cell *matHeaderCellDef>Principal</th>
        <td mat-cell *matCellDef="let emi">{{ emi.principalAmount | inrCurrency }}</td>
      </ng-container>

      <!-- Interest Amount Column -->
      <ng-container matColumnDef="interestAmount">
        <th mat-header-cell *matHeaderCellDef>Interest</th>
        <td mat-cell *matCellDef="let emi">{{ emi.interestAmount | inrCurrency }}</td>
      </ng-container>

      <!-- Total EMI Column -->
      <ng-container matColumnDef="totalEmi">
        <th mat-header-cell *matHeaderCellDef>Total EMI</th>
        <td mat-cell *matCellDef="let emi" class="amount-cell">{{ emi.totalEmi | inrCurrency }}</td>
      </ng-container>

      <!-- Principal Balance Column -->
      <ng-container matColumnDef="principalBalance">
        <th mat-header-cell *matHeaderCellDef>Balance</th>
        <td mat-cell *matCellDef="let emi">{{ emi.outstandingBalance | inrCurrency }}</td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let emi">
          <mat-chip [ngClass]="getStatusBadgeClass(emi.status)">
            {{ (emi.status | statusBadge).text }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let emi">
          @if (canPayEmi(emi)) {
            <button mat-icon-button
                    color="primary"
                    matTooltip="Record Payment"
                    (click)="openPaymentDialog(emi)">
              <mat-icon>payment</mat-icon>
            </button>
          }
          @if (emi.status === 'PAID') {
            <mat-icon class="paid-icon" matTooltip="Payment Completed">check_circle</mat-icon>
          }
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"
          [class.paid-row]="row.status === 'PAID'"
          [class.overdue-row]="row.status === 'OVERDUE'">
      </tr>
    </table>

    <div *ngIf="isLoading()" class="loading-overlay">
      <mat-spinner></mat-spinner>
    </div>

    <div *ngIf="!isLoading() && emiSchedule().length === 0" class="no-data">
      <mat-icon>inbox</mat-icon>
      <p>No EMI schedule found for this loan</p>
    </div>
  </div>

  <!-- Payment History Section -->
  @if (paymentHistory().length > 0) {
    <div class="payment-history-container">
      <h2 class="section-title">
        <mat-icon>history</mat-icon>
        Payment History
      </h2>

      <div class="table-container">
        <table mat-table [dataSource]="paymentHistory()" class="payment-table">
          <!-- Payment Date Column -->
          <ng-container matColumnDef="paymentDate">
            <th mat-header-cell *matHeaderCellDef>Payment Date</th>
            <td mat-cell *matCellDef="let payment">{{ payment.paymentDate | date: 'dd MMM yyyy' }}</td>
          </ng-container>

          <!-- Payment Amount Column -->
          <ng-container matColumnDef="paymentAmount">
            <th mat-header-cell *matHeaderCellDef>Amount</th>
            <td mat-cell *matCellDef="let payment" class="amount-cell">{{ payment.paymentAmount | inrCurrency }}</td>
          </ng-container>

          <!-- Payment Method Column -->
          <ng-container matColumnDef="paymentMethod">
            <th mat-header-cell *matHeaderCellDef>Method</th>
            <td mat-cell *matCellDef="let payment">
              <mat-chip class="method-chip">{{ getPaymentMethodLabel(payment.paymentMethod) }}</mat-chip>
            </td>
          </ng-container>

          <!-- Transaction Reference Column -->
          <ng-container matColumnDef="transactionReference">
            <th mat-header-cell *matHeaderCellDef>Transaction Ref</th>
            <td mat-cell *matCellDef="let payment">{{ payment.transactionReference || '-' }}</td>
          </ng-container>

          <!-- Recorded By Column -->
          <ng-container matColumnDef="recordedBy">
            <th mat-header-cell *matHeaderCellDef>Recorded By</th>
            <td mat-cell *matCellDef="let payment">{{ payment.recordedByName }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="paymentColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: paymentColumns;"></tr>
        </table>

        <div *ngIf="isLoadingPayments()" class="loading-overlay">
          <mat-spinner></mat-spinner>
        </div>
      </div>
    </div>
  }
</div>
